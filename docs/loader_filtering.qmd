---
title: "Loader Table Filtering"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: true
execute:
  warning: false
  message: false
---


```{r, echo=FALSE}
library(tidyverse)
library(readr)
library(DT)
library(cli)
library(glue)

out_dir <- "../data/loader-tables"

read_lt <- function(filename) {
  path <- file.path(out_dir, filename)
  if (!file.exists(path)) cli_abort("Missing loader table: {path}")
  read_csv(path, show_col_types = FALSE, progress = FALSE)
}

filter_with_audit <- function(df, condition, reason) {
  kept <- df %>% filter({{ condition }})
  dropped <- df %>%
    filter(!({{ condition }})) %>%
    mutate(drop_reason = reason)
  list(kept = kept, dropped = dropped)
}

dt <- function(x, pageLength = 25) {
  datatable(
    x,
    rownames = FALSE,
    filter = "top",
    options = list(pageLength = pageLength, autoWidth = TRUE, scrollX = TRUE)
  )
}
```

```{r}
plots <- read_lt("plotsLT.csv")
projects <- read_lt("projectLT.csv")
party <- read_lt("partyLT.csv")
contrib <- read_lt("contributorLT.csv")
dist <- read_lt("disturbanceLT.csv")
comm <- read_lt("communityClassificationsLT.csv")
strat <- read_lt("strataCoverLT.csv") %>%
  select(where(~ !all(is.na(.)))) %>%
  mutate(user_tm_code = user_to_code)
tax <- read_lt("taxonInterpretationsLT.csv") %>%
  select(where(~ !all(is.na(.))))

# NOTE: StrataMethodsLT.csv does not exist for now

required_cols <- list(
  projects = c("user_pj_code"),
  plots    = c("user_pj_code", "user_ob_code", "latitude", "longitude"),
  dist     = c("user_ob_code"),
  comm     = c("user_ob_code", "vb_cc_code"),
  strat    = c("user_ob_code", "user_sr_code", "author_plant_name", "user_to_code"),
  tax      = c("user_to_code", "vb_pc_code")
)

missing_report <- imap(required_cols, function(cols, nm) {
  df <- get(nm, envir = environment())
  missing <- setdiff(cols, names(df))
  tibble(table = nm, missing_cols = paste(missing, collapse = ", ")) %>%
    filter(missing_cols != "")
}) %>% bind_rows()

if (nrow(missing_report) > 0) {
  cli_abort("Some required columns are missing:\n{paste0(apply(missing_report, 1, paste, collapse=': '), collapse='\n')}")
}
```


```{r}
audit <- list()

proj_codes <- projects %>%
  transmute(user_pj_code = str_squish(as.character(user_pj_code))) %>%
  filter(!is.na(user_pj_code), user_pj_code != "") %>%
  distinct() %>%
  pull(user_pj_code)

# Plots
a1 <- filter_with_audit(
  plots,
  !is.na(latitude) & !is.na(longitude),
  "plots: missing latitude and/or longitude"
)
plots_step1 <- a1$kept
audit[["plots_missing_latlon"]] <- a1$dropped

a2 <- filter_with_audit(
  plots_step1,
  user_pj_code %in% proj_codes,
  "plots: user_pj_code not found in projectLT"
)
plots_semi <- a2$kept
audit[["plots_missing_project_link"]] <- a2$dropped

plot_obs_codes <- plots_semi %>%
  transmute(user_ob_code = str_squish(as.character(user_ob_code))) %>%
  filter(!is.na(user_ob_code), user_ob_code != "") %>%
  distinct() %>%
  pull(user_ob_code)

# Disturbance
a3 <- filter_with_audit(
  dist,
  user_ob_code %in% plot_obs_codes,
  "disturbance: user_ob_code not found in filtered plotsLT"
)
dist_semi <- a3$kept
audit[["disturbance_missing_plot_link"]] <- a3$dropped

# Comm Class
a4 <- filter_with_audit(
  comm,
  user_ob_code %in% plot_obs_codes,
  "community: user_ob_code not found in filtered plotsLT"
)
comm_step1 <- a4$kept
audit[["community_missing_plot_link"]] <- a4$dropped

a5 <- filter_with_audit(
  comm_step1,
  !is.na(vb_cc_code) & vb_cc_code != "",
  "community: missing vb_cc_code (unmapped concept)"
)
comm_semi <- a5$kept %>% select(where(~ !all(is.na(.))))
audit[["community_missing_vb_cc_code"]] <- a5$dropped

# Strata Cover (no StrataMethodsLT to validate user_sr_code against)
a8 <- filter_with_audit(
  strat,
  user_ob_code %in% plot_obs_codes,
  "strataCover: user_ob_code not found in filtered plotsLT"
)
strat_step1 <- a8$kept
audit[["strataCover_missing_plot_link"]] <- a8$dropped

a9 <- filter_with_audit(
  strat_step1,
  !is.na(author_plant_name) & author_plant_name != "",
  "strataCover: missing author_plant_name"
)
strat_step2 <- a9$kept
audit[["strataCover_missing_author_plant_name"]] <- a9$dropped

a10 <- filter_with_audit(
  strat_step2,
  !is.na(user_sr_code) & str_squish(as.character(user_sr_code)) != "",
  "strataCover: missing user_sr_code (no StrataMethodsLT available to validate)"
)
strat_semi <- a10$kept
audit[["strataCover_missing_user_sr_code"]] <- a10$dropped

taxon_to_codes <- strat_semi %>%
  transmute(user_to_code = str_squish(as.character(user_to_code))) %>%
  filter(!is.na(user_to_code), user_to_code != "") %>%
  distinct() %>%
  pull(user_to_code)

# Taxon Interpretations
has_vb_ro <- "vb_ro_code" %in% names(tax)

if (has_vb_ro) {
  a11 <- filter_with_audit(
    tax,
    !is.na(vb_pc_code) & vb_pc_code != "" & !is.na(vb_ro_code) & vb_ro_code != "",
    "taxon: missing vb_pc_code and/or vb_ro_code"
  )
} else {
  a11 <- filter_with_audit(
    tax,
    !is.na(vb_pc_code) & vb_pc_code != "",
    "taxon: missing vb_pc_code"
  )
}

tax_step1 <- a11$kept
audit[["taxon_missing_required_vb_codes"]] <- a11$dropped

a12 <- filter_with_audit(
  tax_step1,
  user_to_code %in% taxon_to_codes,
  "taxon: user_to_code not found in filtered strataCoverLT"
)
tax_semi <- a12$kept
audit[["taxon_missing_strataCover_link"]] <- a12$dropped

summary_tbl <- tibble(
  step = c(
    "plots: missing lat/lon",
    "plots: missing project link",
    "disturbance: missing plot link",
    "community: missing plot link",
    "community: missing vb_cc_code",
    "strataCover: missing plot link",
    "strataCover: missing author_plant_name",
    "strataCover: missing user_sr_code (no StrataMethodsLT)",
    if (has_vb_ro) "taxon: missing vb_pc_code/vb_ro_code" else "taxon: missing vb_pc_code",
    "taxon: missing strataCover link"
  ),
  dropped_rows = c(
    nrow(a1$dropped),
    nrow(a2$dropped),
    nrow(a3$dropped),
    nrow(a4$dropped),
    nrow(a5$dropped),
    nrow(a8$dropped),
    nrow(a9$dropped),
    nrow(a10$dropped),
    nrow(a11$dropped),
    nrow(a12$dropped)
  )
)
```

```{r}
dt(summary_tbl, pageLength = 25)
```

# plots lat/lon
```{r}
x <- audit[["plots_missing_latlon"]] %>%
  select(any_of(c("user_ob_code", "user_pl_code", "user_pj_code", "latitude", "longitude", "drop_reason"))) %>%
  head(500)
dt(x, pageLength = 25)
```

# plots: project code not found in projectsLT
```{r}
x <- audit[["plots_missing_project_link"]] %>%
  select(any_of(c("user_ob_code", "user_pl_code", "user_pj_code", "drop_reason"))) %>%
  head(500)
dt(x, pageLength = 25)
```

# disturbance dropped: not linked to existing plot obs
```{r}
x <- audit[["disturbance_missing_plot_link"]] %>%
  select(any_of(c("user_ob_code", "disturbance_type", "intensity", "drop_reason"))) %>%
  head(500)
dt(x, pageLength = 25)
```

# community dropped: not linked to a kept plot obs
```{r}
x <- audit[["community_missing_plot_link"]] %>%
  select(any_of(c("user_ob_code", "vb_cc_code", "comm_level", "drop_reason"))) %>%
  head(500)
dt(x, pageLength = 25)
```

# community: missing vb_cc_code
```{r}
x <- audit[["community_missing_vb_cc_code"]] %>%
  select(any_of(c("user_ob_code", "vb_cc_code", "drop_reason"))) %>%
  head(500)
dt(x, pageLength = 25)
```

# strataCover: not linked to a kept plot obs
```{r}
x <- audit[["strataCover_missing_plot_link"]] %>%
  select(any_of(c("user_ob_code", "user_sr_code", "user_to_code", "author_plant_name", "drop_reason"))) %>%
  head(500)
dt(x, pageLength = 25)
```

# strataCover: missing author_plant_name
```{r}
x <- audit[["strataCover_missing_author_plant_name"]] %>%
  select(any_of(c("user_ob_code", "user_sr_code", "user_to_code", "author_plant_name", "drop_reason"))) %>%
  head(500)
dt(x, pageLength = 25)
```

# Taxon dropped: missing required VegBank codes
```{r}
cols <- c("user_to_code", "vb_pc_code", if (has_vb_ro) "vb_ro_code", "drop_reason")
x <- audit[["taxon_missing_required_vb_codes"]] %>%
  select(any_of(cols)) %>%
  head(500)
dt(x, pageLength = 25)
```

# taxon dropped: not linked to filtered strata cover
```{r}
x <- audit[["taxon_missing_strataCover_link"]] %>%
  select(any_of(c("user_to_code", "vb_pc_code", if (has_vb_ro) "vb_ro_code", "drop_reason"))) %>%
  head(500)
dt(x, pageLength = 25)
```

