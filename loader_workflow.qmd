---
title: "Loader Table Workflow"
format: html
editor: visual
---

## Introduction

This quarto document describes processing and quality assurance steps used to convert CDFW data into the format needed for ingest into vegbank. Each loader table has a function in the family `[table]_loader` which is run on input data and generates output files at the desired location. Messages from the loader functions indicate potential issues with input datasets.

```{r, echo = FALSE}
library(dplyr)
library(stringr)
library(readr)
library(DT)
#googlesheets4::gs4_auth()
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
file_path <- "R"
r_scripts_source <- list.files(file_path, recursive = FALSE, full.names = TRUE, pattern = "\\.[Rr]$") %>% 
  grep("stratadefinitions", ., invert = TRUE, value = TRUE)
invisible(lapply(r_scripts_source, source))
```

```{r}
in_dir <- '/var/data/curation/vegbank/'
out_dir <- 'data/loader-tables'
```

## Projects

Project loader table data is extracted from `RAProjects` files.

The project start and stop dates are converted from date-time formats to date formats (dropping the time). Date values are checked to ensure they are reasonable.

```{r}
project_loader(in_dir, out_dir)
```

## Party and Contributor

The two loader tables for Party and Contributor are both extracted from `RAProjects` files.

The source data is normalized, moving from wide to long format so that each individual in `DataContact*{n}` columns is in their own row. Emails are checked to ensure they appear valid. Names are then split using whitespace into `given_name`, `middle_name`, and `sur_name`. Unique party codes are generated for each individual (`user_py_code`). Additionally, all unique individuals already in vegbank are retrieved, along with their project codes. Individuals in the source data are matched to existing vegbank parties, and if any are found the existing vegbank identifier is assigned to `vb_py_code`.

`role` (a vegbank code starting with `ar.`) is derived from the `DataContactRole{n}` columns, which are free text. These values are standardized and mapped to VegBank role codes using a lookup table. The full mapping used in this process is shown below for transparency and review. If no role is found in the source data, the code ar.46 is assigned. The contributor_type field is given a value of "Project" for all rows.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# This is the VegBank role code reference (same as in party_contributor_loader)
roles <- tribble(
  ~ar_code, ~role_name,
  "ar.16",  "Author",
  "ar.17",  "Contact",
  "ar.18",  "PI",
  "ar.19",  "Data Manager",
  "ar.34",  "Classifier",
  "ar.36",  "Plot author",
  "ar.38",  "Co-PI",
  "ar.39",  "Computer (automated)",
  "ar.40",  "Consultant",
  "ar.43",  "Field assistant",
  "ar.44",  "Guide",
  "ar.45",  "Land owner",
  "ar.46",  "Not specified",
  "ar.47",  "Not specified/Unknown",
  "ar.48",  "Passive observer",
  "ar.50",  "Plot contributor",
  "ar.51",  "Publication author",
  "ar.53",  "Research advisor",
  "ar.54",  "System manager",
  "ar.55",  "Taxonomist",
  "ar.56",  "Data aggregator"
)

role_lookup_path <- file.path(in_dir, "lookup-tables", "cdfw-roles-2026-02-02.csv")

role_lookup <- read_csv(role_lookup_path, show_col_types = FALSE) %>%
  rename(ContactRole = found, role_name = allowed) %>%
  mutate(
    ContactRole = str_to_lower(str_squish(ContactRole)),
    role_name   = str_squish(role_name)
  )

role_map_final <- role_lookup %>%
  left_join(roles, by = "role_name") %>%
  arrange(role_name, ContactRole) %>%
  select(ContactRole, role_name, ar_code)

datatable(
  role_map_final,
  rownames = FALSE,
  filter = "top",
  options = list(
    pageLength = 25,
    autoWidth = TRUE,
    scrollX = TRUE
))
```

```{r}
party_contributor_loader(in_dir, out_dir)
```

## Disturbance

Disturbance data is extracted from `RAImpacts.csv` files, as well as the `LImpacts.csv` lookup table, which provides descriptive labels for impact codes.

Intensity values are checked to ensure they conform to expected values (1, 2, or 3). Valid intensity codes are converted to descriptive labels: 1 becomes "Low", 2 becomes "Moderate", and 3 becomes "High". Any non-standard intensity values are left as `NA`. Unknown values in the `CodeImpact` field not present in the impacts lookup table are identified. Impact codes present in the `CodeImpact` field but missing from the impacts lookup table are identified. These values are converted to `NA` in the `disturbance_type` field.

Disturbance age and extent are not present in the CDFW data. They are set to `NA` for all rows in the loader table.

The lookup table maps specific impact types from CDFW data to standardized VegBank disturbance categories. Detailed impact descriptions (i.e., "Development", "ORV activity", "Grazing", etc.) are converted into broader, standardized categories (i.e., "Human, general", "Roads and vehicular traffic", etc.) The full mapping used in this process is shown below for transparency and review.

```{r}
roles <- tribble(
  ~`CDFW Impact Type`,                        ~vegbank_disturbance,
    "Development",                            "Human, general",
    "ORV activity",                           "Roads and vehicular traffic",
    "Agriculture",                            "Cultivation",
    "Grazing",                                "Grazing, domestic stock",
    "Competition from exotics",               "Other disturbances",
    "Logging",                                "Timber harvest, general",
    "Insufficient population/stand size",     "Other disturbances",
    "Altered flood/tidal regime",             "Hydrologic alteration",
    "Mining",                                 "Human, general",
    "Hybridization",                          "Other disturbances",
    "Groundwater pumping",                    "Hydrologic alteration",
    "Dam/inundation",                         "Hydrologic alteration",
    "Other",                                  "Other disturbances",
    "Surface water diversion",                "Hydrologic alteration",
    "Road/trail construction/maint.",         "Roads and vehicular traffic",
    "Biocides",                               "Herbicide or chemical",
    "Pollution",                              "Human, general",
    "Unknown",                                "unknown",
    "Vandalism/dumping/litter",               "Human, general",
    "Foot traffic/trampling",                 "Trampling and trails",
    "Improper burning regime",                "Fire suppression",
    "Over collecting/poaching",               "Human, general",
    "Erosion/runoff",                         "Erosion",
    "Altered thermal regime",                 "Other disturbances",
    "Landfill",                               "Human, general",
    "Degrading water quality",                "Hydrologic alteration",
    "Wood cutting",                           "Timber harvest, selective",
    "Military operations",                    "Human, general",
    "Recreational use (non ORV)",              "Trampling and trails",
    "Nest parasitism",                        "Natural, general",
    "Non-native predators",                   "Other disturbances",
    "Rip-rap, bank protection",               "Hydrologic alteration",
    "Channelization (human caused)",           "Hydrologic alteration",
    "Feral pigs",                             "Animal, general",
    "Burros",                                 "Animal, general",
    "Rills",                                  "Erosion",
    "Phytogenic mounding",                    "Erosion",
    "Sudden Oak Death (SODS)",                 "Plant disease",
    NA, "Unknown"
)

datatable(
  roles,
  rownames = FALSE,
  filter = "top",
  options = list(
    pageLength = 25,
    autoWidth = TRUE,
    scrollX = TRUE
))
```

## Plots

```{r}
plots_loader(in_dir, out_dir)
```

## Soils

```{r}
soil_loader(in_dir, out_dir)
```

## Community

```{r}
community_loader(in_dir, out_dir)
```

## Strata, Cover, Taxonomy

```{r}
stratacover_taxon_loader(in_dir, out_dir)
```
