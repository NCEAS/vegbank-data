---
title: "Loader Table Workflow"
format: html
editor: visual
---

## Introduction

This quarto document describes processing and quality assurance steps used to convert CDFW data into the format needed for ingest into vegbank. Each loader table has a function in the family `[table]_loader` which is run on input data and generates output files at the desired location. Messages from the loader functions indicate potential issues with input datasets.

```{r, echo = FALSE}
googlesheets4::gs4_auth()
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
file_path <- "R"
r_scripts_source <- list.files(file_path, recursive = FALSE, full.names = TRUE, pattern = "\\.[Rr]$") %>% 
  grep("community", ., value = TRUE, invert = TRUE)
invisible(lapply(r_scripts_source, source))
```

```{r}
in_dir <- '/var/data/curation/vegbank/'
out_dir <- 'data/loader-tables'
```

## Projects

Project loader table data is extracted from `RAProjects` files.


The project start and stop dates are converted from date-time formats to date formats (dropping the time). Date values are checked to ensure they are reasonable.

```{r}
project_loader(in_dir, out_dir)
```

## Party and Contributor

The two loader tables for Party and Contributor are both extracted from `RAProjects` files.

The source data is normalized, moving from wide to long format so that each individual in `DataContact*{n}` columns is in their own row. Emails are checked to ensure they appear valid. Names are then split using whitespace into `given_name`, `middle_name`, and `sur_name`. Unique party codes are generated for each individual (`user_py_code`). Additionally, all unique individuals already in vegbank are retrieved, along with their project codes. Individuals in the source data are matched to existing vegbank parties, and if any are found the existing vegbank identifier is assigned to `vb_py_code`.

`role` (a vegbank code starting with `ar.`) is derived from the `DataContactRole{n}` columns, which are free text. A mapping of role text to role codes can be found within the `party_contributor_loader` function. If no role is found in the source data, the code `ar.46` is assigned. The `contributor_type` field is given a value of "Project" for all rows.

```{r}
party_contributor_loader(in_dir, out_dir)
```

## Disturbance

Disturbance data is extracted from `RAImpacts.csv` files, as well as the `LImpacts.csv` lookup table. 

Intensity values are checked to ensure they are either 1, 2, or 3, and then these values are converted to low, medium, and high, respectively. Unknown intensity values are left as `NA`. Unknown values in the `CodeImpact` field not present in the impacts lookup table are identified. These values are converted to `NA` in the `disturbance_type` field. Disturbance age and extent are not present in the CDFW data so are set to `NA` for all rows in the loader table.

```{r}
disturbance_loader(in_dir, out_dir)
```

## Plots

```{r}
plots_loader(in_dir, out_dir)
```


## Soils

```{r}
soil_loader(in_dir, out_dir)
```

## Community

```{r}
community_loader(in_dir, out_dir)
```

```{r}
un <- plots_merged %>% 
  distinct(SurveyID, Stand_ID) %>% 
  group_by(Stand_ID) %>% 
  summarise(num_surveys = n())

t <- plots_merged %>% 
  filter(Stand_ID == "SNF6A3515")
```

