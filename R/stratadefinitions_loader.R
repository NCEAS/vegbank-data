library(tidyverse)
library(vegbankr)
library(purrr)
source('R/build_loader_table.R')


load_stratadef_files <- function(in_dir, out_dir){
  # loading CA lookup table
  sub_folders <- dir(in_dir, full.names = TRUE) %>%
    grep(pattern = "VegBankProject", value = TRUE)
  
  plant_files <- dir(sub_folders, full.names = TRUE) %>% 
    grep(pattern = 'RAPlants.csv', value = TRUE)
  
  plants_df_list <- lapply(plant_files, 
                           read_csv,
                           progress = FALSE,
                           show_col_types = FALSE,
                           guess_max = 20000)
  plants <- do.call(bind_rows, plants_df_list)
  
  # read in RAProjects
  project_files <- dir(sub_folders, full.names = TRUE) %>% 
    grep(pattern = "RAProjects.csv", value = TRUE)
  
  projects_df_list <- lapply(project_files, read_csv, progress = FALSE, show_col_types = FALSE)
  projects <- do.call(bind_rows, projects_df_list) %>% 
    group_by(ProjectCode) %>% 
    arrange(desc(nchar(ProjectDescription))) %>% 
    select(ProjectCode, `Type of protocols`, StrataDescription, StrataClassDescription) %>% 
    slice(1)
  
  
  
  plots_path <- file.path(out_dir, "plotsLT.csv")
  if (!file.exists(plots_path)){
    cli::cli_abort("Plots loader table not found. Check {out_dir} for the presence of plotsLT.csv. This file is generated by `R/plots_loader.R`")
  }
  plots <- read_csv(plots_path, show_col_types = FALSE, progress = FALSE) %>% 
    rename(proj_code = user_pj_code, SurveyID = user_ob_code) %>% 
    select(SurveyID, proj_code) %>% 
    distinct()
  
  ret <- list("plants" = plants, "projects" = projects, "plots" = plots)
  return(ret)
}

# clean up some strata names by project based on feedback from CDFW
# this ensures strata with a vegbank strata method get the stratum 
# names correctly assigned to a vb code
clean_strata_names <- function(plant_projs){
  
  method_corrections <- tibble::tribble(~proj_code, ~Stratum, ~Stratum_norm,
                                        "ALCC", "nv", "non-vasc",
                                        "ALCC-GR", "nv", "non-vasc",
                                        "SCRUZ", "shrubs", "shrub",
                                        "SLAV", "shrubs", "shrub",
                                        "SLAV", "shrutb", "shrub",
                                        "SLAV", "shsrub", "shrub"
                                        )
  
  
  plant_projs_clean <- plant_projs %>% 
    mutate(Stratum = tolower(Stratum)) %>% 
    left_join(method_corrections, by = join_by(Stratum, proj_code)) %>% 
    mutate(Stratum = if_else(!is.na(Stratum_norm), Stratum_norm, Stratum)) %>% 
    select(-Stratum_norm)
  
  return(plant_projs_clean)
}

stratadefinitions_loader <- function(in_dir, out_dir){
  out <- load_stratadef_files(in_dir, out_dir)
  list2env(out, envir = environment())
  
  # get a list of unique strata types and strata method descriptions
  proj_plots <- left_join(plots, projects, by = c("proj_code" = "ProjectCode"))
  plant_projs <- left_join(plants, proj_plots, by = "SurveyID")
  plant_projs <- clean_strata_names(plant_projs)
  
  base_url <- "https://api-dev.vegbank.org"
  vb_set_base_url(base_url)
  vb_strata <- vb_get_stratum_methods(with_nested = TRUE)
  
  vb_strata <- vb_strata %>% 
    mutate(stratum_names = map(stratum_types, ~ tolower(.x$stratum_index), collapse = ", "))
  
  vb_full <- vb_strata %>% 
    unnest(stratum_types) %>% 
    mutate(stratum_index = tolower(stratum_index)) %>% 
    rename(Stratum = stratum_index) %>% 
    select(sm_code, Stratum, sy_code) %>% 
    group_by(sm_code, Stratum) %>% 
    slice(1) %>% 
    ungroup()
  
  method_lookup <- read.csv(file.path(in_dir, "lookup-tables/CDFW-strata-method.csv")) %>% 
    select(proj_code, stratum_method_name) %>% 
    left_join(vb_strata, by = join_by(stratum_method_name)) %>% 
    select(proj_code, sm_code)
  
  
  plant_methods <- plant_projs %>% 
    left_join(method_lookup, by = join_by(proj_code)) %>% 
    left_join(vb_full, by = join_by(Stratum, sm_code)) %>% 
    select(SurveyID, Stratum, sm_code, sy_code, RAPlantsID)
  
  
  strata_template_fields <- build_loader_table(
    sheet_url = "https://docs.google.com/spreadsheets/d/1ORubguw1WDkTkfiuVp2p59-eX0eA8qMQUEOfz1TWfH0/edit?gid=2109807393#gid=2109807393",
    sheet = "StrataDefinitions",
    source_df = plants
  )
  
  strata_def_LT <- strata_template_fields$template
  
  # required fields
  strata_def_LT$user_ob_code <- plant_methods$SurveyID
  strata_def_LT$user_sr_code <- plant_methods$RAPlantsID
  strata_def_LT$vb_sy_code <- plant_methods$sy_code
  
  out_path_strata <- file.path(out_dir, "strataMethodsLT.csv")

  cli::cli_alert_success("Writing output file to:")
  cli::cli_ul(out_path_strata)
  
  write.csv(strata_def_LT, out_path_strata, row.names = F)
  
}